---
author: slowe
categories: Information
comments: true
date: 2020-08-31T13:30:00-05:00
tags:
- AWS
- CAPI
- Kubernetes
title: "Behavior Changes in clusterawsadm 0.5.5"
url: /2020/08/31/behavior-changes-in-clusterawsadm-055/
---

Late last week I needed to test some Kubernetes functionality, so I thought I'd spin up a test cluster really quick using [Cluster API (CAPI)][link-2]. As often happens with fast-moving projects like [Kubernetes][link-3] and CAPI, my existing CAPI environment had gotten a little out of date. So I updated my environment, and along the way picked up an important change in the default behavior of the `clusterawsadm` tool used by the [Cluster API Provider for AWS (CAPA)][link-4]. In this post, I'll share more information on this change in default behavior and the impacts of that change.<!--more-->

The `clusterawsadm` tool is part of CAPA and is used to help manage AWS-specific aspects, particularly around credentials and IAM (Identity and Access Management). As outlined in [this doc][link-6], users use `clusterawsadm` to create a CloudFormation stack that prepares an AWS account for use with CAPA. This stack contains roles and policies that enable CAPA to function as expected.

Here's the change in default behavior:

* In `clusterawsadm` 0.5.4 and earlier, using `clusterawsadm` to create or update the CloudFormation stack would also create a bootstrap IAM user and group by default.
* In `clusterawsadm` 0.5.5 and later, creating or updating the associated CloudFormation stack does _not_ create a bootstrap IAM user or group.

This change in default behavior is briefly documented in the 0.5.5 release [here][link-5]. As mentioned in the release, the default behavior can be changed with a configuration file (API reference is available [here][link-1]).

In and of itself, this change in default behavior isn't significant. What _is_ significant is what happens if you use `clusterawsadm` 0.5.4 or earlier to create the necessary CAPA stack, and then use `clusterawsadm` 0.5.5 or later to update this stack. In such cases, if you haven't taken steps to change the default behavior then **the bootstrap IAM user and group are removed**. When this happens, you'll start to see error messages like this (or similar):

```text
The user with name bootstrapper.cluster-api-provider-aws.sigs.k8s.io cannot be found
```

If your CAPI management cluster is using those credentials to interact with AWS, the CAPA controllers on that management cluster are now broken. You'll have to update the CAPA controllers to use a new set of credentials (see [this blog post][xref-1] for information on that process) before any CAPI-related operations will succeed.

One of the CAPA contributors (thanks, Naadir!) did point out that it is still possible to use the pre-0.5.5 `clusterawsadm alpha` commands in the 0.5.5 release. The CLI help text has been completely removed, but the command to run is `clusterawsadm alpha bootstrap generate-cloudformation <aws-account-id>` (this generates the CloudFormation template only; use `clusterawsadm alpha bootstrap create-stack` to actually create the stack). This command works with both the 0.5.4 and 0.5.5 releases of `clusterawsadm`, although the latter will generate a deprecation warning. _However,_ the CloudFormation template generated by `clusterawsadm` 0.5.5 is **not identical** to the template generated by the 0.5.4 release; it lacks a name for the bootstrap IAM group. I have not tested what impact this has on existing CAPA stacks.

To get identical output (at least, with regard to the bootstrap user and group) between the two releases of `clusterawsadm`, you must generate a configuration file and make sure this section is present in the configuration file:

```yaml
spec:
  bootstrapUser:
    enable: true
    userName: bootstrapper.cluster-api-provider-aws.sigs.k8s.io
    groupName: bootstrapper.cluster-api-provider-aws.sigs.k8s.io
```

Then specify the configuration file when running `clusterawsadm`:

```shell
clusterawsadm bootstrap iam create-cloudformation-stack --config config.yaml
```

Based on my testing, this should generate a CloudFormation stack that, with regard to the bootstrap IAM user and group, is identical to stacks created with `clusterawsadm` 0.5.4 and earlier. Thus, if you have existing CAPA environments prepared with `clusterawsadm` 0.5.4 and earlier, then---at least with regard to the bootstrap IAM user and group---it is safe to update these environments with `clusterawsadm` 0.5.5.

If anyone has questions, feel free to find me on [the K8s Slack][link-7] or hit [me on Twitter][link-8]. I'll do my best to help.

[link-1]: https://pkg.go.dev/sigs.k8s.io/cluster-api-provider-aws/cmd/clusterawsadm/api/bootstrap/v1alpha1
[link-2]: https://cluster-api.sigs.k8s.io/
[link-3]: https://kubernetes.io/
[link-4]: https://github.com/kubernetes-sigs/cluster-api-provider-aws
[link-5]: https://github.com/kubernetes-sigs/cluster-api-provider-aws/releases/tag/v0.5.5
[link-6]: https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/master/docs/prerequisites.md
[link-7]: https://kubernetes.slack.com/
[link-8]: https://twitter.com/scott_lowe
[xref-1]: {{< relref "2020-09-02-updating-aws-credentials-in-cluster-api.md" >}}
